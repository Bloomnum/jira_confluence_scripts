import com.atlassian.jira.issue.MutableIssue
import com.atlassian.jira.issue.IssueManager
import groovy.json.JsonSlurper
import com.atlassian.jira.issue.Issue;
import com.atlassian.jira.issue.fields.CustomField;
import com.atlassian.jira.component.ComponentAccessor;

def myIssueKey = issue.key
IssueManager issueManager = ComponentAccessor.getIssueManager()
MutableIssue myIssue = issueManager.getIssueObject(myIssueKey)

// Извлечение значений из полей "Организация (insight)" и "Продукт (актив)"
def orgField = "Организация (insight)"
def productField = "Продукт (актив)"
def orgValue = myIssue.getCustomFieldValue(orgField).id[0]
def productValue = myIssue.getCustomFieldValue(productField).id[0]

// 1) Сработал триггер -> Получили результат : объекты "Технический проект" из AQL ЗАПРОСА :
def jsonString = ruleContext.renderSmartValues('{{lookupAssets.objectKey.asJsonObject("key").asJsonArray}}')

addMessage("Результат в джейсон : " + jsonString)

// Проверяем, является ли jsonString пустой или содержит только пробелы
if (jsonString == '[]') {
    addMessage("Запрос AQL не нашел объекты попадающие в фильтр. Резутат запроса равен : " + jsonString)
}

else {
    def jsonSlurper = new JsonSlurper()
    def object = jsonSlurper.parseText(jsonString)

    List matchingProject = []

    object.each { item ->
        def asset_value = Assets.getByKey((item.key).toString())

        // 2) Извлекаем значения атрибутов из полученых объектов Технический проект" в aql.
        //    Атрибуты : "Ссылка на организацию", "Используемые продукты и решения"

        def attr_org = asset_value.getAttributeValues('Ссылка на организацию').referenceId[0]
        def attr_product = asset_value.getAttributeValues('Используемые продукты и решения').referenceId[0]

        // 3) Проверяем, совпадают ли значения: в задаче = в объекте, если да то добавлем проект
        if (orgValue == attr_org && productValue == attr_product) {
            matchingProject += item.key
        }
    }

    // 4) Добавляем мэтч-проекты в cf в задачу SIRIUS
    myIssue.update {
        setCustomFieldValue('Технический проект (insight)') {
            matchingProject.each { value ->
                add(value.toString())
                //addMessage("Добавленые проекты в поле задачи Sirius : " + value)
            }
        }
    }

    // 5) Связываем эпик Project с задачей SIRIUS
    // matchingProject.each { project_obj ->
    //     def asset_value = Assets.getByKey((project_obj).toString())
    //     def attr_value_link_on_epic = asset_value.getAttributeValues('Ссылка на эпик').value

    //     attr_value_link_on_epic.each { epicUrl ->
    //         def epicKey = epicUrl.split("/")[-1] // Получаем последний сегмент URL, который должен быть ключом задачи

    //         //addMessage("Эпик epicKey : $epicKey")

    //         def epicIssue = issueManager.getIssueObject(epicKey)
    //         addMessage("что получаем в epicIssue " + epicIssue)

    //         if (epicIssue == null){

    //             addMessage("Задачи не существует или она удалена/недоступна : " + epicIssue)
    //         }

    //         else {

    //             def sourceIssue = Issues.getByKey("$epicKey")

    //             sourceIssue.link('связана с', myIssue)
    //         }

    //     }
    // }
}
